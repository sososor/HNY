<script>
    // API URL は相対パス(デプロイ環境に合わせるため)
    const apiUrl = window.location.origin;
    let authToken = localStorage.getItem('authToken');
    if (!authToken) {
        alert("ログインが必要です！");
        window.location.href = "login.html";
    }
  
    async function fetchTasks() {
        try {
            const response = await fetch(`${apiUrl}/tasks`, {
                headers: { 'Authorization': `Bearer ${authToken}` },
            });
            const tasks = await response.json();
            document.getElementById("habits-list").innerHTML = "";
            document.getElementById("main-goals-list").innerHTML = "";
            document.getElementById("sub-goals-list").innerHTML = "";
            tasks.forEach(task => { addTaskToList(task); });
        } catch (error) {
            console.error('タスクの取得エラー:', error);
        }
    }
  
    function addTaskToList(task) {
        let ul;
        if (task.type === "habit") {
            ul = document.getElementById("habits-list");
        } else if (task.type === "main") {
            ul = document.getElementById("main-goals-list");
        } else {
            ul = document.getElementById("sub-goals-list");
        }
        let li = document.createElement("li");
  
        let numberSpan = document.createElement("span");
        numberSpan.className = "item-number";
        // 番号は後で updateListNumbers で更新
  
        let contentSpan = document.createElement("span");
        contentSpan.className = "item-content";
        contentSpan.textContent = task.content;
  
        let controlsDiv = document.createElement("div");
        controlsDiv.className = "controls";
  
        let upButton = document.createElement("button");
        upButton.textContent = "↑";
        upButton.onclick = function() { moveUp(li); };
  
        let downButton = document.createElement("button");
        downButton.textContent = "↓";
        downButton.onclick = function() { moveDown(li); };
  
        let deleteButton = document.createElement("button");
        deleteButton.textContent = "削除";
        deleteButton.onclick = function() { deleteTask(task.id); };
  
        controlsDiv.appendChild(upButton);
        controlsDiv.appendChild(downButton);
        controlsDiv.appendChild(deleteButton);
  
        li.appendChild(numberSpan);
        li.appendChild(contentSpan);
        li.appendChild(controlsDiv);
  
        ul.appendChild(li);
        updateListNumbers(ul);
    }
  
    function updateListNumbers(ul) {
        let items = ul.getElementsByTagName("li");
        for (let i = 0; i < items.length; i++) {
            let numberSpan = items[i].getElementsByClassName("item-number")[0];
            numberSpan.textContent = (i + 1) + ". ";
        }
    }
  
    function moveUp(li) {
        let prev = li.previousElementSibling;
        if (prev) {
            li.parentNode.insertBefore(li, prev);
            updateListNumbers(li.parentNode);
        }
    }
  
    function moveDown(li) {
        let next = li.nextElementSibling;
        if (next) {
            li.parentNode.insertBefore(next, li);
            updateListNumbers(li.parentNode);
        }
    }
  
    async function addItem(type) {
        let inputId;
        if (type === 'main') {
            inputId = 'mainGoalInput';
        } else if (type === 'sub') {
            inputId = 'subGoalInput';
        } else {
            inputId = type + 'Input';
        }
        const input = document.getElementById(inputId);
        const content = input.value.trim();
        if (content === "") {
            alert(`${type}は空白にできません`);
            return;
        }
        const task = { content, type };
        try {
            const response = await fetch(`${apiUrl}/tasks`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`,
                },
                body: JSON.stringify(task),
            });
            const newTask = await response.json();
            addTaskToList(newTask);
            input.value = "";
        } catch (error) {
            console.error("タスクの追加エラー:", error);
        }
    }
  
    async function deleteTask(id) {
        try {
            const response = await fetch(`${apiUrl}/tasks/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${authToken}` },
            });
            if (response.ok) {
                // 削除確認のアラートは表示せずにタスク一覧を更新
                fetchTasks();
            } else { 
                alert('タスク削除のエラー'); 
            }
        } catch (error) {
            console.error('タスク削除エラー:', error);
        }
    }
  
    function logout() {
        localStorage.removeItem('authToken');
        window.location.href = "/";
    }
  
    // エンターキー押下で保存するためのイベントリスナーを各入力欄に追加
    document.getElementById("habitInput").addEventListener("keydown", function(e){
      if(e.key === "Enter") {
        e.preventDefault();
        addItem('habit');
      }
    });
    document.getElementById("mainGoalInput").addEventListener("keydown", function(e){
      if(e.key === "Enter") {
        e.preventDefault();
        addItem('main');
      }
    });
    document.getElementById("subGoalInput").addEventListener("keydown", function(e){
      if(e.key === "Enter") {
        e.preventDefault();
        addItem('sub');
      }
    });
  
    window.onload = function() { fetchTasks(); }
  </script>
  </body>
  </html>
  